<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标准日语 初级上册 - 第一课</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Noto+Sans+SC&display=swap" rel="stylesheet">
    <style>
        .audio-button {
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 12px;
            vertical-align: middle;
            min-width: 30px;
        }
        .audio-button:hover {
            background: #005c99;
        }
        .audio-button:active {
            background: #004d80;
        }
        .audio-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .speech-controls {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
        .speed-control {
            margin-left: 10px;
        }
        .speed-control select {
            font-size: 11px;
            padding: 2px;
        }
        .audio-status {
            font-size: 10px;
            color: #888;
            margin-left: 5px;
        }
        .audio-fallback {
            background: #28a745;
            margin-left: 5px;
        }
        .audio-fallback:hover {
            background: #218838;
        }
        .pronounce-hint {
            font-size: 10px;
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .audio-playing {
            animation: pulse 1s infinite;
            background: #dc3545 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>标准日语 初级上册V2</h1>
            <h2>第一课：はじめまして</h2>
            <h3>初次见面</h3>
        </header>

        <div class="lesson-navigation">
            <a href="index.html" class="nav-home" title="返回目录"><i class="nav-icon">🏠</i><span>目录</span></a>
            <a href="#" class="nav-prev" title="没有上一课" style="visibility: hidden;"><i class="nav-icon">◀</i><span>上一课</span></a>
            <a href="lesson2.html" class="nav-next" title="下一课：これは本です"><i class="nav-icon">▶</i><span>下一课</span></a>
        </div>

        <section class="dialogue">
            <h3>会話（かいわ）- 对话</h3>
            <div class="dialogue-container">
                <div class="dialogue-scene">
                    <p class="scene-description">（李さんは森さんの研究室を訪ねます）</p>
                    <p class="scene-description-cn">（小李拜访森老师的研究室）</p>
                </div>
                
                <div class="dialogue-line">
                    <p class="speaker">李：</p>
                    <div class="speech">
                        <p class="japanese speech-text">すみません。
                            <button class="audio-button" onclick="playJapanese('すみません')">🔊</button>
                        </p>
                        <p class="kana">すみません。</p>
                        <p class="romaji">Sumimasen.</p>
                        <p class="chinese">打扰了。</p>
                    </div>
                </div>

                <div class="dialogue-line">
                    <p class="speaker">森：</p>
                    <div class="speech">
                        <p class="japanese speech-text">はい、どうぞ。
                            <button class="audio-button" onclick="playJapanese('はい、どうぞ')">🔊</button>
                        </p>
                        <p class="kana">はい、どうぞ。</p>
                        <p class="romaji">Hai, douzo.</p>
                        <p class="chinese">请进。</p>
                    </div>
                </div>
                
                <div class="dialogue-line">
                    <p class="speaker">李：</p>
                    <div class="speech">
                        <p class="japanese speech-text">はじめまして。中国から来ました李です。どうぞよろしくお願いします。
                            <button class="audio-button" onclick="playJapanese('はじめまして。中国から来ました李です。どうぞよろしくお願いします')">🔊</button>
                        </p>
                        <p class="kana">はじめまして。ちゅうごくから きました り です。どうぞよろしく おねがいします。</p>
                        <p class="romaji">Hajimemashite. Chūgoku kara kimashita Ri desu. Douzo yoroshiku onegaishimasu.</p>
                        <p class="chinese">初次见面。我是来自中国的小李。请多多关照。</p>
                    </div>
                </div>
                
                <div class="dialogue-line">
                    <p class="speaker">森：</p>
                    <div class="speech">
                        <p class="japanese speech-text">はじめまして。森です。どうぞよろしく。
                            <button class="audio-button" onclick="playJapanese('はじめまして。森です。どうぞよろしく')">🔊</button>
                        </p>
                        <p class="kana">はじめまして。もり です。どうぞよろしく。</p>
                        <p class="romaji">Hajimemashite. Mori desu. Douzo yoroshiku.</p>
                        <p class="chinese">初次见面。我是森。请多关照。</p>
                    </div>
                </div>

                <div class="dialogue-line">
                    <p class="speaker">李：</p>
                    <div class="speech">
                        <p class="japanese speech-text">日本語を勉強しています。
                            <button class="audio-button" onclick="playJapanese('日本語を勉強しています')">🔊</button>
                        </p>
                        <p class="kana">にほんごを べんきょうしています。</p>
                        <p class="romaji">Nihongo o benkyō shite imasu.</p>
                        <p class="chinese">我正在学习日语。</p>
                    </div>
                </div>

                <div class="dialogue-line">
                    <p class="speaker">森：</p>
                    <div class="speech">
                        <p class="japanese speech-text">そうですか。頑張ってください。
                            <button class="audio-button" onclick="playJapanese('そうですか。頑張ってください')">🔊</button>
                        </p>
                        <p class="kana">そうですか。がんばってください。</p>
                        <p class="romaji">Sō desu ka. Ganbatte kudasai.</p>
                        <p class="chinese">是吗？请加油。</p>
                    </div>
                </div>

                <div class="dialogue-line">
                    <p class="speaker">李：</p>
                    <div class="speech">
                        <p class="japanese speech-text">ありがとうございます。
                            <button class="audio-button" onclick="playJapanese('ありがとうございます')">🔊</button>
                        </p>
                        <p class="kana">ありがとうございます。</p>
                        <p class="romaji">Arigatou gozaimasu.</p>
                        <p class="chinese">谢谢您。</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="vocabulary">
            <h3>単語（たんご）- 单词
                <div class="speech-controls">
                    语速: 
                    <select id="speechRate" class="speed-control">
                        <option value="0.7">慢速</option>
                        <option value="0.9" selected>正常</option>
                        <option value="1.2">快速</option>
                    </select>
                </div>
            </h3>
            <table>
                <thead>
                    <tr>
                        <th>日语</th>
                        <th>假名</th>
                        <th>罗马音</th>
                        <th>中文</th>
                        <th>发音</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="word-text">はじめまして</span></td>
                        <td>はじめまして</td>
                        <td>hajimemashite</td>
                        <td>初次见面</td>
                        <td><button class="audio-button" onclick="playJapanese('はじめまして')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">すみません</span></td>
                        <td>すみません</td>
                        <td>sumimasen</td>
                        <td>打扰了、对不起</td>
                        <td><button class="audio-button" onclick="playJapanese('すみません')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">はい</span></td>
                        <td>はい</td>
                        <td>hai</td>
                        <td>是、好的</td>
                        <td><button class="audio-button" onclick="playJapanese('はい')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">どうぞ</span></td>
                        <td>どうぞ</td>
                        <td>douzo</td>
                        <td>请</td>
                        <td><button class="audio-button" onclick="playJapanese('どうぞ')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">中国</span></td>
                        <td>ちゅうごく</td>
                        <td>chūgoku</td>
                        <td>中国</td>
                        <td><button class="audio-button" onclick="playJapanese('中国')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">から</span></td>
                        <td>から</td>
                        <td>kara</td>
                        <td>从...（助词）</td>
                        <td><button class="audio-button" onclick="playJapanese('から')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">来ました</span></td>
                        <td>きました</td>
                        <td>kimashita</td>
                        <td>来了（动词"来"的过去式）</td>
                        <td><button class="audio-button" onclick="playJapanese('来ました')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">です</span></td>
                        <td>です</td>
                        <td>desu</td>
                        <td>是（助动词）</td>
                        <td><button class="audio-button" onclick="playJapanese('です')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">よろしく</span></td>
                        <td>よろしく</td>
                        <td>yoroshiku</td>
                        <td>请多关照</td>
                        <td><button class="audio-button" onclick="playJapanese('よろしく')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">お願いします</span></td>
                        <td>おねがいします</td>
                        <td>onegaishimasu</td>
                        <td>拜托了</td>
                        <td><button class="audio-button" onclick="playJapanese('お願いします')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">日本語</span></td>
                        <td>にほんご</td>
                        <td>nihongo</td>
                        <td>日语</td>
                        <td><button class="audio-button" onclick="playJapanese('日本語')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">を</span></td>
                        <td>を</td>
                        <td>o</td>
                        <td>（助词，表示动作的对象）</td>
                        <td><button class="audio-button" onclick="playJapanese('を')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">勉強しています</span></td>
                        <td>べんきょうしています</td>
                        <td>benkyō shite imasu</td>
                        <td>正在学习</td>
                        <td><button class="audio-button" onclick="playJapanese('勉強しています')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">そうですか</span></td>
                        <td>そうですか</td>
                        <td>sō desu ka</td>
                        <td>是吗？</td>
                        <td><button class="audio-button" onclick="playJapanese('そうですか')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">頑張ってください</span></td>
                        <td>がんばってください</td>
                        <td>ganbatte kudasai</td>
                        <td>请加油</td>
                        <td><button class="audio-button" onclick="playJapanese('頑張ってください')">🔊</button></td>
                    </tr>
                    <tr>
                        <td><span class="word-text">ありがとうございます</span></td>
                        <td>ありがとうございます</td>
                        <td>arigatou gozaimasu</td>
                        <td>谢谢</td>
                        <td><button class="audio-button" onclick="playJapanese('ありがとうございます')">🔊</button></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="grammar-points">
            <h3>文法（ぶんぽう）- 语法</h3>
            <div class="grammar-point">
                <h4>1. 「AはBです」句型</h4>
                <p>表示"A是B"的意思，是最基本的判断句型。</p>
                <div class="example">
                    <p class="japanese speech-text">私は李です。
                        <button class="audio-button" onclick="playJapanese('私は李です')">🔊</button>
                    </p>
                    <p class="kana">わたしは り です。</p>
                    <p class="romaji">Watashi wa Ri desu.</p>
                    <p class="chinese">我是李。</p>
                </div>
                <div class="example">
                    <p class="japanese speech-text">これは本です。
                        <button class="audio-button" onclick="playJapanese('これは本です')">🔊</button>
                    </p>
                    <p class="kana">これは ほん です。</p>
                    <p class="romaji">Kore wa hon desu.</p>
                    <p class="chinese">这是书。</p>
                </div>
            </div>

            <div class="grammar-point">
                <h4>2. 「どうぞよろしくお願いします」表达</h4>
                <p>是一种在初次见面时表达"请多关照"的礼貌用语。</p>
                <div class="example">
                    <p class="japanese speech-text">どうぞよろしくお願いします。
                        <button class="audio-button" onclick="playJapanese('どうぞよろしくお願いします')">🔊</button>
                    </p>
                    <p class="kana">どうぞよろしく おねがいします。</p>
                    <p class="romaji">Douzo yoroshiku onegaishimasu.</p>
                    <p class="chinese">请多多关照。</p>
                </div>
                <div class="note">
                    <p>也可以简化为「どうぞよろしく」，稍微不那么正式。</p>
                </div>
            </div>

            <div class="grammar-point">
                <h4>3. 「～から来ました」句型</h4>
                <p>表示"从...来"，说明出发点或来源。</p>
                <div class="example">
                    <p class="japanese speech-text">中国から来ました。</p>
                    <p class="kana">ちゅうごくから きました。</p>
                    <p class="romaji">Chūgoku kara kimashita.</p>
                    <p class="chinese">我来自中国。</p>
                </div>
                <div class="example">
                    <p class="japanese speech-text">東京から来ました。</p>
                    <p class="kana">とうきょうから きました。</p>
                    <p class="romaji">Tōkyō kara kimashita.</p>
                    <p class="chinese">我来自东京。</p>
                </div>
            </div>

            <div class="grammar-point">
                <h4>4. 「～を勉強しています」句型</h4>
                <p>表示"正在学习...", 使用进行时态。</p>
                <div class="example">
                    <p class="japanese speech-text">日本語を勉強しています。</p>
                    <p class="kana">にほんごを べんきょうしています。</p>
                    <p class="romaji">Nihongo o benkyō shite imasu.</p>
                    <p class="chinese">我正在学习日语。</p>
                </div>
                <div class="example">
                    <p class="japanese speech-text">歴史を勉強しています。</p>
                    <p class="kana">れきしを べんきょうしています。</p>
                    <p class="romaji">Rekishi o benkyō shite imasu.</p>
                    <p class="chinese">我正在学习历史。</p>
                </div>
            </div>
        </section>

        <section class="example-sentences">
            <h3>応用例文（おうようれいぶん）- 应用例句</h3>
            <div class="example">
                <p class="japanese speech-text">私は王です。中国から来ました。</p>
                <p class="kana">わたしは おう です。ちゅうごくから きました。</p>
                <p class="romaji">Watashi wa Wang desu. Chūgoku kara kimashita.</p>
                <p class="chinese">我是王。我来自中国。</p>
            </div>
            <div class="example">
                <p class="japanese speech-text">田中さんは学生です。</p>
                <p class="kana">たなかさんは がくせい です。</p>
                <p class="romaji">Tanaka-san wa gakusei desu.</p>
                <p class="chinese">田中先生是学生。</p>
            </div>
            <div class="example">
                <p class="japanese speech-text">あなたは日本人ですか。</p>
                <p class="kana">あなたは にほんじん ですか。</p>
                <p class="romaji">Anata wa nihonjin desu ka.</p>
                <p class="chinese">你是日本人吗？</p>
            </div>
            <div class="example">
                <p class="japanese speech-text">はい、私は日本人です。</p>
                <p class="kana">はい、わたしは にほんじん です。</p>
                <p class="romaji">Hai, watashi wa nihonjin desu.</p>
                <p class="chinese">是的，我是日本人。</p>
            </div>
        </section>

        <section class="exam-practice">
            <h3>日语能力测试 N5 真题练习</h3>
            <p class="section-intro">以下是与第一课相关的N5水平考试真题，练习后可以点击查看答案。</p>
            
            <div class="exam-section vocabulary-test">
                <h4>单词部分</h4>
                
                <div class="question">
                    <p class="question-number">1.</p>
                    <p class="question-text">「はじめまして」の意味は何ですか。</p>
                    <div class="options">
                        <p>A. 你好</p>
                        <p>B. 初次见面</p>
                        <p>C. 谢谢</p>
                        <p>D. 再见</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：B. 初次见面</p>
                        <p class="explanation">「はじめまして」是在第一次见面时使用的问候语，相当于汉语中的"初次见面"。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">2.</p>
                    <p class="question-text">次の言葉の読み方として正しいものはどれですか。「日本語」</p>
                    <div class="options">
                        <p>A. にっぽんご</p>
                        <p>B. にほんごご</p>
                        <p>C. にほんご</p>
                        <p>D. にっぽんごご</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：C. にほんご</p>
                        <p class="explanation">「日本語」的正确读法是「にほんご」(nihongo)，表示"日语"。</p>
                    </div>
                </div>
            </div>
            
            <div class="exam-section grammar-test">
                <h4>语法部分</h4>
                
                <div class="question">
                    <p class="question-number">3.</p>
                    <p class="question-text">わたし（　　）学生です。</p>
                    <div class="options">
                        <p>A. を</p>
                        <p>B. は</p>
                        <p>C. が</p>
                        <p>D. に</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：B. は</p>
                        <p class="explanation">「AはBです」是表示"A是B"的基本句型，其中「は」是提示主题的助词。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">4.</p>
                    <p class="question-text">李さんは中国（　　）来ました。</p>
                    <div class="options">
                        <p>A. を</p>
                        <p>B. は</p>
                        <p>C. から</p>
                        <p>D. に</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：C. から</p>
                        <p class="explanation">「から」表示出发点或来源，在此句中表示"从中国来"。</p>
                    </div>
                </div>
            </div>
            
            <div class="exam-section reading-test">
                <h4>阅读理解部分</h4>
                
                <div class="reading-passage">
                    <p>田中：はじめまして。田中です。</p>
                    <p>王：はじめまして。王です。中国から来ました。</p>
                    <p>田中：王さんは学生ですか。</p>
                    <p>王：はい、そうです。日本語を勉強しています。</p>
                    <p>田中：そうですか。私も中国語を勉強しています。どうぞよろしく。</p>
                    <p>王：こちらこそ、よろしくお願いします。</p>
                </div>
                
                <div class="question">
                    <p class="question-number">5.</p>
                    <p class="question-text">王さんはどこから来ましたか。</p>
                    <div class="options">
                        <p>A. 日本</p>
                        <p>B. アメリカ</p>
                        <p>C. 中国</p>
                        <p>D. 韓国</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：C. 中国</p>
                        <p class="explanation">对话中王说「中国から来ました」，表明他来自中国。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">6.</p>
                    <p class="question-text">田中さんは何を勉強していますか。</p>
                    <div class="options">
                        <p>A. 英語</p>
                        <p>B. 中国語</p>
                        <p>C. 日本語</p>
                        <p>D. 韓国語</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：B. 中国語</p>
                        <p class="explanation">对话中田中说「私も中国語を勉強しています」，表明他在学习中文。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">7.</p>
                    <p class="question-text">王さんは何をしていますか。</p>
                    <div class="options">
                        <p>A. 先生です</p>
                        <p>B. 会社員です</p>
                        <p>C. 学生です</p>
                        <p>D. 医者です</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：C. 学生です</p>
                        <p class="explanation">对话中田中问「王さんは学生ですか」，王回答「はい、そうです」，确认他是学生。</p>
                    </div>
                </div>
            </div>
            
            <div class="exam-section listening-test">
                <h4>听力部分</h4>
                <p class="section-note">以下是听力测试相关题目，在实际考试中会听录音回答。此处可以点击文本播放音频。</p>
                
                <div class="question">
                    <p class="question-number">8.</p>
                    <p class="listening-script speech-text">はじめまして。私は山田です。中国語を勉強しています。どうぞよろしく。</p>
                    <p class="question-text">この人は何を勉強していますか。</p>
                    <div class="options">
                        <p>A. 英語</p>
                        <p>B. 中国語</p>
                        <p>C. 日本語</p>
                        <p>D. 韓国語</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：B. 中国語</p>
                        <p class="explanation">听力内容中说「中国語を勉強しています」，表示"我在学习中文"。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">9.</p>
                    <p class="listening-script speech-text">すみません、あなたは李さんですか。</p>
                    <p class="question-text">この人は何と言っていますか。</p>
                    <div class="options">
                        <p>A. 询问对方是否是李先生</p>
                        <p>B. 向对方介绍自己是李先生</p>
                        <p>C. 向李先生道歉</p>
                        <p>D. 请李先生帮忙</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：A. 询问对方是否是李先生</p>
                        <p class="explanation">「すみません、あなたは李さんですか」表示"打扰了，请问你是李先生吗？"，是在询问对方的身份。</p>
                    </div>
                </div>
                
                <div class="question">
                    <p class="question-number">10.</p>
                    <p class="listening-script speech-text">私は森です。日本から来ました。どうぞよろしくお願いします。</p>
                    <p class="question-text">森さんはどこから来ましたか。</p>
                    <div class="options">
                        <p>A. 中国</p>
                        <p>B. 日本</p>
                        <p>C. アメリカ</p>
                        <p>D. 韓国</p>
                    </div>
                    <button class="toggle-answer">显示答案</button>
                    <div class="answer-section">
                        <p class="answer">正确答案：B. 日本</p>
                        <p class="explanation">听力内容中说「日本から来ました」，表示"我来自日本"。</p>
                    </div>
                </div>
            </div>
        </section>

        <div class="lesson-pagination">
            <div class="pagination-controls">
                <a href="index.html" class="pagination-home">目录</a>
                <span class="pagination-prev" style="visibility: hidden;">« 上一课</span>
                <span class="pagination-current">第一课</span>
                <a href="lesson2.html" class="pagination-next">第二课 »</a>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // 音频播放状态管理
        let audioContext = null;
        let currentAudio = null;
        let speechSupported = false;
        let japaneseVoice = null;
        
        // 检测音频支持
        function checkAudioSupport() {
            // 检查Web Speech API支持
            if ('speechSynthesis' in window) {
                speechSupported = true;
                console.log('✓ Web Speech API 支持');
            } else {
                console.log('✗ Web Speech API 不支持');
            }
            
            // 检查Web Audio API支持
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('✓ Web Audio API 支持');
            } catch(e) {
                console.log('✗ Web Audio API 不支持');
            }
            
            return speechSupported;
        }
        
        // 初始化日语语音
        function initJapaneseVoice() {
            if (!speechSupported) return;
            
            const voices = speechSynthesis.getVoices();
            console.log('可用语音数量:', voices.length);
            
            // 优先查找日语语音
            const japaneseVoices = voices.filter(voice => 
                voice.lang && (
                    voice.lang.toLowerCase().includes('ja') ||
                    voice.lang.toLowerCase().includes('jp')
                )
            );
            
            if (japaneseVoices.length > 0) {
                japaneseVoice = japaneseVoices[0];
                console.log('✓ 找到日语语音:', japaneseVoice.name, japaneseVoice.lang);
            } else {
                // 查找包含日语关键词的语音
                japaneseVoice = voices.find(voice => 
                    voice.name && (
                        voice.name.toLowerCase().includes('japanese') ||
                        voice.name.toLowerCase().includes('kyoko') ||
                        voice.name.toLowerCase().includes('otoya') ||
                        voice.name.toLowerCase().includes('haruka')
                    )
                );
                
                if (japaneseVoice) {
                    console.log('✓ 找到日语相关语音:', japaneseVoice.name);
                } else {
                    console.log('⚠ 未找到专门的日语语音，将使用默认语音');
                    japaneseVoice = voices[0];
                }
            }
            
            // 更新页面状态显示
            updateAudioStatus();
        }
        
        // 更新音频状态显示
        function updateAudioStatus() {
            const statusElements = document.querySelectorAll('.audio-status');
            const status = japaneseVoice ? 
                `语音: ${japaneseVoice.name.substring(0, 20)}` : 
                '语音: 不可用';
            
            statusElements.forEach(el => {
                el.textContent = status;
            });
        }
        
        // 主要播放函数
        function playJapanese(text, button) {
            console.log('尝试播放:', text);
            
            // 停止当前播放
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // 重置按钮状态
            const allButtons = document.querySelectorAll('.audio-button');
            allButtons.forEach(btn => {
                btn.classList.remove('audio-playing');
                btn.disabled = false;
                btn.textContent = '🔊';
            });
            
            if (!speechSupported) {
                showFallbackOption(text, button);
                return;
            }
            
            // 设置按钮状态
            if (button) {
                button.classList.add('audio-playing');
                button.disabled = true;
                button.textContent = '⏸';
            }
            
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // 设置语音参数
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }
                utterance.lang = 'ja-JP';
                utterance.rate = parseFloat(document.getElementById('speechRate')?.value || 0.8);
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // 事件处理
                utterance.onstart = function() {
                    console.log('▶ 开始播放:', text);
                };
                
                utterance.onend = function() {
                    console.log('⏹ 播放结束:', text);
                    if (button) {
                        button.classList.remove('audio-playing');
                        button.disabled = false;
                        button.textContent = '🔊';
                    }
                };
                
                utterance.onerror = function(event) {
                    console.error('❌ 播放错误:', event.error);
                    if (button) {
                        button.classList.remove('audio-playing');
                        button.disabled = false;
                        button.textContent = '🔊';
                    }
                    
                    // 根据错误类型提供不同的处理
                    if (event.error === 'not-allowed') {
                        alert('🔒 音频播放被浏览器阻止。\n\n解决方法：\n1. 刷新页面后重试\n2. 检查浏览器音频权限设置\n3. 尝试手动点击页面任意位置后再播放');
                    } else if (event.error === 'network') {
                        showFallbackOption(text, button);
                    } else {
                        showFallbackOption(text, button);
                    }
                };
                
                // 执行播放
                speechSynthesis.speak(utterance);
                
            } catch (error) {
                console.error('❌ 播放异常:', error);
                if (button) {
                    button.classList.remove('audio-playing');
                    button.disabled = false;
                    button.textContent = '🔊';
                }
                showFallbackOption(text, button);
            }
        }
        
        // 备用方案：显示发音提示
        function showFallbackOption(text, button) {
            // 简单的罗马音转换（基础版）
            const romajiMap = {
                'すみません': 'su-mi-ma-sen',
                'はじめまして': 'ha-ji-me-ma-shi-te',
                'ありがとうございます': 'a-ri-ga-to-u go-za-i-ma-su',
                'はい': 'hai',
                'どうぞ': 'do-u-zo',
                'です': 'de-su',
                'よろしく': 'yo-ro-shi-ku',
                'お願いします': 'o-ne-ga-i-shi-ma-su',
                '中国': 'chu-u-go-ku',
                '日本語': 'ni-ho-n-go',
                '勉強しています': 'be-n-kyo-u shi-te i-ma-su'
            };
            
            const romaji = romajiMap[text] || text;
            
            // 创建发音提示
            const hint = document.createElement('span');
            hint.className = 'pronounce-hint';
            hint.textContent = `[${romaji}]`;
            hint.style.color = '#007acc';
            hint.style.fontWeight = 'bold';
            
            // 显示提示
            if (button && button.parentNode) {
                // 移除已存在的提示
                const existingHint = button.parentNode.querySelector('.pronounce-hint');
                if (existingHint) {
                    existingHint.remove();
                }
                
                button.parentNode.appendChild(hint);
                
                // 3秒后移除提示
                setTimeout(() => {
                    if (hint.parentNode) {
                        hint.remove();
                    }
                }, 3000);
            }
            
            // 提供在线TTS备用链接（仅在移动设备上）
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                setTimeout(() => {
                    if (confirm(`音频播放不可用。\n\n是否使用在线语音服务播放？\n文本: ${text}`)) {
                        // 使用Google Translate的TTS API（非官方）
                        const encodedText = encodeURIComponent(text);
                        const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&q=${encodedText}&tl=ja`;
                        
                        const audio = new Audio(ttsUrl);
                        audio.play().catch(e => {
                            alert('在线语音服务也无法使用，请参考罗马音发音: ' + romaji);
                        });
                    }
                }, 500);
            }
        }
        
        // 用户交互激活音频
        function activateAudio() {
            if (speechSupported && speechSynthesis) {
                // 播放一个静音测试来激活音频上下文
                const testUtterance = new SpeechSynthesisUtterance('');
                testUtterance.volume = 0;
                speechSynthesis.speak(testUtterance);
            }
            
            // 移除激活监听器
            document.removeEventListener('click', activateAudio);
            document.removeEventListener('touchstart', activateAudio);
            
            console.log('✓ 音频上下文已激活');
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 页面加载完成，初始化音频系统...');
            
            // 检查音频支持
            checkAudioSupport();
            
            // 添加用户交互监听器以激活音频
            document.addEventListener('click', activateAudio, { once: true });
            document.addEventListener('touchstart', activateAudio, { once: true });
            
            // 初始化语音
            if (speechSupported) {
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', initJapaneseVoice);
                } else {
                    initJapaneseVoice();
                }
                
                // 延迟再次尝试初始化（某些浏览器需要）
                setTimeout(initJapaneseVoice, 1000);
            }
            
            // 更新所有音频按钮
            const audioButtons = document.querySelectorAll('.audio-button');
            audioButtons.forEach((button, index) => {
                const text = button.getAttribute('onclick').match(/'([^']+)'/)?.[1] || '';
                button.setAttribute('onclick', '');
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    playJapanese(text, this);
                });
                
                // 添加状态显示
                if (index === 0) {
                    const status = document.createElement('span');
                    status.className = 'audio-status';
                    status.textContent = '检测中...';
                    button.parentNode.appendChild(status);
                }
            });
            
            // 自动更新页码导航
            updatePagination();
            
            // 添加使用提示
            setTimeout(() => {
                const firstButton = document.querySelector('.audio-button');
                if (firstButton && speechSupported) {
                    firstButton.style.animation = 'pulse 2s 3';
                    firstButton.title = '点击播放日语发音';
                }
            }, 2000);
            
            console.log('✅ 音频系统初始化完成');
        });

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            .audio-button {
                transition: all 0.2s ease;
            }
            .audio-button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(style);

        function updatePagination() {
            // 获取当前页面文件名
            const currentPath = window.location.pathname;
            const currentPage = currentPath.substring(currentPath.lastIndexOf('/') + 1);
            
            // 提取当前课程编号
            const currentLessonMatch = currentPage.match(/lesson(\d+)\.html/);
            if (!currentLessonMatch) return;
            
            const currentLessonNum = parseInt(currentLessonMatch[1]);
            const prevLessonNum = currentLessonNum - 1;
            const nextLessonNum = currentLessonNum + 1;
            
            // 更新导航链接
            const prevLink = document.querySelector('.nav-prev');
            const nextLink = document.querySelector('.nav-next');
            const paginationPrev = document.querySelector('.pagination-prev');
            const paginationNext = document.querySelector('.pagination-next');
            const paginationCurrent = document.querySelector('.pagination-current');
            
            // 检查前一课是否存在
            if (prevLessonNum >= 1) {
                const prevUrl = `lesson${prevLessonNum}.html`;
                prevLink.href = prevUrl;
                prevLink.style.visibility = 'visible';
                
                paginationPrev.href = prevUrl;
                paginationPrev.textContent = `« 第${toChineseNumber(prevLessonNum)}课`;
                paginationPrev.style.visibility = 'visible';
            } else {
                prevLink.style.visibility = 'hidden';
                paginationPrev.style.visibility = 'hidden';
            }
            
            // 总是更新当前课程编号
            paginationCurrent.textContent = `第${toChineseNumber(currentLessonNum)}课`;
            
            // 从当前DOM中检测已知的课程链接
            const courseLinks = detectExistingCourseLinks();
            const maxLessons = Math.max(...courseLinks, 6); // 至少支持6课
            
            if (nextLessonNum <= maxLessons) {
                const nextUrl = `lesson${nextLessonNum}.html`;
                nextLink.href = nextUrl;
                nextLink.style.visibility = 'visible';
                
                paginationNext.href = nextUrl;
                paginationNext.textContent = `第${toChineseNumber(nextLessonNum)}课 »`;
                paginationNext.style.visibility = 'visible';
            } else {
                nextLink.style.visibility = 'hidden';
                paginationNext.style.visibility = 'hidden';
            }
        }
        
        // 从当前DOM中检测已知的课程链接
        function detectExistingCourseLinks() {
            const links = document.querySelectorAll('a[href^="lesson"]');
            const courseNumbers = [];
            
            links.forEach(link => {
                const match = link.getAttribute('href').match(/lesson(\d+)\.html/);
                if (match && match[1]) {
                    courseNumbers.push(parseInt(match[1]));
                }
            });
            
            return courseNumbers.length > 0 ? courseNumbers : [6]; // 默认至少6课
        }
        
        function toChineseNumber(num) {
            // 简单的数字转中文数字，适用于课程编号
            const chineseNumbers = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
            if (num <= 10) return chineseNumbers[num];
            if (num < 20) return '十' + (num > 10 ? chineseNumbers[num - 10] : '');
            const tens = Math.floor(num / 10);
            const ones = num % 10;
            return chineseNumbers[tens] + '十' + (ones > 0 ? chineseNumbers[ones] : '');
        }
    </script>
</body>
</html>
